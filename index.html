<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link href="css/slider.css"  rel="stylesheet" type="text/css" />
	<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.3.1/leaflet.css" />
	<style type="text/css">
        html { height: 100% }
        body { height: 100%; margin: 0; padding: 0 }
    	#map { height: 80%; width:80% }
    </style>
    
    <script src="http://code.jquery.com/jquery-latest.js"></script>
	<script src="http://cdn.leafletjs.com/leaflet-0.3.1/leaflet.js"></script>
	<script type="text/javascript" src="slider.js"></script>

	<script>
	$( function(){
		// create the slider
		( 
            new Razorfish.Slider({
		        width : 800,
			    handleWidth : 10,
			    useRange : true,
			    tabs : [
				  { text : '7h',  date: new Date('01/01/2009 7:00')  }, 
				  { text : '8h',  date: new Date('01/01/2009 8:00')  }, 
				  { text : '9h',  date: new Date('01/01/2009 9:00')  }, 
				  { text : '10h', date: new Date('01/01/2009 10:00') }, 
				  { text : '11h', date: new Date('01/01/2009 11:00') }, 
				  { text : '12h', date: new Date('01/01/2009 12:00') }, 
				  { text : '13h', date: new Date('01/01/2009 13:00') }, 
				  { text : '14h', date: new Date('01/01/2009 14:00') }, 
				  { text : '15h', date: new Date('01/01/2009 15:00') }, 
				  { text : '16h', date: new Date('01/01/2009 16:00') }, 
				  { text : '17h', date: new Date('01/01/2009 17:00') }, 
				  { text : '18h', date: new Date('01/01/2009 18:00') }, 
				  { text : '19h', date: new Date('01/01/2009 19:00') }, 
				  { text : '20h', date: new Date('01/01/2009 20:00') }, 
				  { text : '21h', date: new Date('01/01/2009 21:00') }, 
				  { text : '22h', date: new Date('01/01/2009 22:00') }, 
				  { text : '23h', date: new Date('01/01/2009 23:00') }
			      ]
		    }) 
		)
		.prependTo( $("#slider") )
		.bind     ( 'rangeMoved', rangeMoved )
		.setRange ( 2, 4 );
	});

    var KEY = "hHRhSfLgXxcrqJvYNVZETrFdehggBmjDhKBBIqLL";

	function rangeMoved( ev, minTab, maxTab ){
		map.removeLayer( shapes_layer );
		shapes_layer = new L.LayerGroup();
		requestTrips(minTab, maxTab);
		map.addLayer( shapes_layer );	
	};
	
	function getColor(sortable, index){
	    total     = sortable.length;
	    percentil = sortable[index][1]/(sortable[total-1][1]-sortable[0][1]+1) *100;
	    if (percentil >= 50) {
	        return "#F00";
	    } else if (percentil >= 25) {
	        return "#FFBB00";
	    }; else {
	        return "#FFEE00";
	    };
	};
	
	function countStartTimes(start_times, max){
	    count = 0;
	    for (var i=0; i < start_times.length; i++) {
	        time = new Date('01/01/2009 '+start_times[i])
	        if (time <= max.date) {
	            count += 1;
	        };
	    };
        return count;
	};
	
	function sortShapes(){
	    var sortable = [];
        for (var shape_id in SHAPE_IDS)
            sortable.push([shape_id, SHAPE_IDS[shape_id]])
        sortable.sort(function(a, b) {return a[1] - b[1]})
        return sortable
	}
	
	var SHAPE_IDS = {};
	var RESULTS_PER_PAGE = 50;
	
	function requestTrips(from, to, offset){
	    offset = offset ? offset : 0;
	    $.ajax({
            url:      'https://api.ost.pt/trips',
            dataType: 'jsonp',
            data:     {
                key:       KEY,
                time:      ""+from.date.getHours()+":00:00",
                results:   RESULTS_PER_PAGE,
                offset:    RESULTS_PER_PAGE*offset,
            },
            success:  function( response ) {
                if (response.Meta.paginated_objects) {
                    for (var i=0; i < response.Objects.length; i++) {
                        trip = response.Objects[i];
                        if (trip.shape_id in SHAPE_IDS) {
                            SHAPE_IDS[ trip.shape_id ] += countStartTimes(trip.start_times, to);
                        } else {
                            SHAPE_IDS[ trip.shape_id ]  = countStartTimes(trip.start_times, to);
                        };
                    };
                    requestTrips( from, to, offset+1 );
                }else {
                    sortable  = sortShapes()  
                    SHAPE_IDS = {}                                   
                    for (var i in sortable) {
                        color = getColor( sortable, i );
                        for (var j=0; j < sortable[i][1]; j++) {
                            requestShape( sortable[i][0], color );
                        };
                    };
                };
            }
        });
	};	
	function requestShape(id, color){
	    $.ajax({
            url:      'https://api.ost.pt/shapes/'+id,
            dataType: 'jsonp',
            data:     {
                key: KEY
            },
            success:  function( response ) {
                coords = response.line_string.coordinates;
                line   = []; 
                for (var j in coords) {
                    line[j] = new L.LatLng( coords[j][1], coords[j][0] );
                }
                shapes_layer.addLayer( new L.Polyline( line, {
                    color: color,
                    fillOpacity: 0.1,
                    opacity: 0.1,
                }) );
            }
        });
	};
	
	</script>
</head>
<body>
    <div id="map"></div>
    <script type="text/javascript" charset="utf-8">
        // CLOUDMADE SETTINGS
		var cloudmade_url         = 'http://{s}.tile.cloudmade.com/BC9A493B41014CAABB98F0471D759707/22677/256/{z}/{x}/{y}.png';
		var cloudmade_attribution = 'Map data &copy; 2011 OpenStreetMap contributors, Imagery &copy; 2011 CloudMade';
		var cloudmade             = new L.TileLayer( cloudmade_url, {
		    maxZoom:     18, 
		    attribution: cloudmade_attribution
		});

        var shapes_layer = new L.LayerGroup();
        
		// MAP
        var map = new L.Map('map', {
            center: new L.LatLng(40.219679, -8.4181),
            zoom:   14,
            layers: [shapes_layer],
            doubleClickZoom: false,
        });
        map.addLayer( shapes_layer );
        map.addLayer( cloudmade );
    </script>
    <div id="slider" style="margin-top: 10px">
        
    </div>
    
</body>
</html>